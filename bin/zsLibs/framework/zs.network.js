window.zs=window.zs||{},function(t){"use strict";let e;!function(t){t[t.Local=0]="Local",t[t.Async=1]="Async",t[t.Sync=2]="Sync"}(e=e||(e={}));class a{static rotateLeft(t,e){return t<<e|t>>>32-e}static addUnsigned(t,e){var a,i,s,r,o;return s=2147483648&t,r=2147483648&e,o=(1073741823&t)+(1073741823&e),(a=1073741824&t)&(i=1073741824&e)?2147483648^o^s^r:a|i?1073741824&o?3221225472^o^s^r:1073741824^o^s^r:o^s^r}static F(t,e,a){return t&e|~t&a}static G(t,e,a){return t&a|e&~a}static H(t,e,a){return t^e^a}static I(t,e,a){return e^(t|~a)}static FF(t,e,a,i,s,r,o){return t=this.addUnsigned(t,this.addUnsigned(this.addUnsigned(this.F(e,a,i),s),o)),this.addUnsigned(this.rotateLeft(t,r),e)}static GG(t,e,a,i,s,r,o){return t=this.addUnsigned(t,this.addUnsigned(this.addUnsigned(this.G(e,a,i),s),o)),this.addUnsigned(this.rotateLeft(t,r),e)}static HH(t,e,a,i,s,r,o){return t=this.addUnsigned(t,this.addUnsigned(this.addUnsigned(this.H(e,a,i),s),o)),this.addUnsigned(this.rotateLeft(t,r),e)}static II(t,e,a,i,s,r,o){return t=this.addUnsigned(t,this.addUnsigned(this.addUnsigned(this.I(e,a,i),s),o)),this.addUnsigned(this.rotateLeft(t,r),e)}static convertToWordArray(t){for(var e,a=t.length,i=a+8,s=16*((i-i%64)/64+1),r=Array(s-1),o=0,n=0;n<a;)o=n%4*8,r[e=(n-n%4)/4]=r[e]|t.charCodeAt(n)<<o,n++;return o=n%4*8,r[e=(n-n%4)/4]=r[e]|128<<o,r[s-2]=a<<3,r[s-1]=a>>>29,r}static wordToHex(t){var e,a="",i="";for(e=0;e<=3;e++)a+=(i="0"+(t>>>8*e&255).toString(16)).substr(i.length-2,2);return a}static uTF8Encode(t){t=t.replace(/\x0d\x0a/g,"\n");for(var e="",a=0;a<t.length;a++){var i=t.charCodeAt(a);i<128?e+=String.fromCharCode(i):i>127&&i<2048?(e+=String.fromCharCode(i>>6|192),e+=String.fromCharCode(63&i|128)):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128),e+=String.fromCharCode(63&i|128))}return e}static md5(t){var e,a,i,s,r,o,n,d,l,g=Array();for(t=this.uTF8Encode(t),g=this.convertToWordArray(t),o=1732584193,n=4023233417,d=2562383102,l=271733878,e=0;e<g.length;e+=16)a=o,i=n,s=d,r=l,o=this.FF(o,n,d,l,g[e+0],7,3614090360),l=this.FF(l,o,n,d,g[e+1],12,3905402710),d=this.FF(d,l,o,n,g[e+2],17,606105819),n=this.FF(n,d,l,o,g[e+3],22,3250441966),o=this.FF(o,n,d,l,g[e+4],7,4118548399),l=this.FF(l,o,n,d,g[e+5],12,1200080426),d=this.FF(d,l,o,n,g[e+6],17,2821735955),n=this.FF(n,d,l,o,g[e+7],22,4249261313),o=this.FF(o,n,d,l,g[e+8],7,1770035416),l=this.FF(l,o,n,d,g[e+9],12,2336552879),d=this.FF(d,l,o,n,g[e+10],17,4294925233),n=this.FF(n,d,l,o,g[e+11],22,2304563134),o=this.FF(o,n,d,l,g[e+12],7,1804603682),l=this.FF(l,o,n,d,g[e+13],12,4254626195),d=this.FF(d,l,o,n,g[e+14],17,2792965006),n=this.FF(n,d,l,o,g[e+15],22,1236535329),o=this.GG(o,n,d,l,g[e+1],5,4129170786),l=this.GG(l,o,n,d,g[e+6],9,3225465664),d=this.GG(d,l,o,n,g[e+11],14,643717713),n=this.GG(n,d,l,o,g[e+0],20,3921069994),o=this.GG(o,n,d,l,g[e+5],5,3593408605),l=this.GG(l,o,n,d,g[e+10],9,38016083),d=this.GG(d,l,o,n,g[e+15],14,3634488961),n=this.GG(n,d,l,o,g[e+4],20,3889429448),o=this.GG(o,n,d,l,g[e+9],5,568446438),l=this.GG(l,o,n,d,g[e+14],9,3275163606),d=this.GG(d,l,o,n,g[e+3],14,4107603335),n=this.GG(n,d,l,o,g[e+8],20,1163531501),o=this.GG(o,n,d,l,g[e+13],5,2850285829),l=this.GG(l,o,n,d,g[e+2],9,4243563512),d=this.GG(d,l,o,n,g[e+7],14,1735328473),n=this.GG(n,d,l,o,g[e+12],20,2368359562),o=this.HH(o,n,d,l,g[e+5],4,4294588738),l=this.HH(l,o,n,d,g[e+8],11,2272392833),d=this.HH(d,l,o,n,g[e+11],16,1839030562),n=this.HH(n,d,l,o,g[e+14],23,4259657740),o=this.HH(o,n,d,l,g[e+1],4,2763975236),l=this.HH(l,o,n,d,g[e+4],11,1272893353),d=this.HH(d,l,o,n,g[e+7],16,4139469664),n=this.HH(n,d,l,o,g[e+10],23,3200236656),o=this.HH(o,n,d,l,g[e+13],4,681279174),l=this.HH(l,o,n,d,g[e+0],11,3936430074),d=this.HH(d,l,o,n,g[e+3],16,3572445317),n=this.HH(n,d,l,o,g[e+6],23,76029189),o=this.HH(o,n,d,l,g[e+9],4,3654602809),l=this.HH(l,o,n,d,g[e+12],11,3873151461),d=this.HH(d,l,o,n,g[e+15],16,530742520),n=this.HH(n,d,l,o,g[e+2],23,3299628645),o=this.II(o,n,d,l,g[e+0],6,4096336452),l=this.II(l,o,n,d,g[e+7],10,1126891415),d=this.II(d,l,o,n,g[e+14],15,2878612391),n=this.II(n,d,l,o,g[e+5],21,4237533241),o=this.II(o,n,d,l,g[e+12],6,1700485571),l=this.II(l,o,n,d,g[e+3],10,2399980690),d=this.II(d,l,o,n,g[e+10],15,4293915773),n=this.II(n,d,l,o,g[e+1],21,2240044497),o=this.II(o,n,d,l,g[e+8],6,1873313359),l=this.II(l,o,n,d,g[e+15],10,4264355552),d=this.II(d,l,o,n,g[e+6],15,2734768916),n=this.II(n,d,l,o,g[e+13],21,1309151649),o=this.II(o,n,d,l,g[e+4],6,4149444226),l=this.II(l,o,n,d,g[e+11],10,3174756917),d=this.II(d,l,o,n,g[e+2],15,718787259),n=this.II(n,d,l,o,g[e+9],21,3951481745),o=this.addUnsigned(o,a),n=this.addUnsigned(n,i),d=this.addUnsigned(d,s),l=this.addUnsigned(l,r);return(this.wordToHex(o)+this.wordToHex(n)+this.wordToHex(d)+this.wordToHex(l)).toLowerCase()}static buildSign(t,e){e=e||!0;for(var a=Object.keys(t).sort(),i="",s=0;s<a.length;s++)i+=a[s]+":"+t[a[s]];e&&(i+=zs.configs.gameCfg.secret);var r=this.md5(i);return r=r.toLowerCase()}}class i{static encrypt(t){let e=CryptoJS.enc.Utf8.parse(i.authorizationSecret),a=CryptoJS.enc.Utf8.parse(t);return CryptoJS.AES.encrypt(a,e,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString()}static decrypt(t){let e=CryptoJS.enc.Utf8.parse(i.authorizationSecret),a=CryptoJS.AES.decrypt(t,e,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return CryptoJS.enc.Utf8.stringify(a).toString()}static async init(){let t=zs.configs.gameCfg;if(i.defaultData=t.network,!t.skipRemote){let e=await zs.resource.nativeLoad(t.remoteWebSettingURL||i.remoteWebSettingURL,null,!0).catch(t=>t);e&&(e.webDomains&&(i.listDomain=e.webDomains),e.webApis&&(e.webApis.ping&&(i.mapWebApi.ping=e.webApis.ping),e.webApis.login&&(i.mapWebApi.login=e.webApis.login),e.webApis.config&&(i.mapWebApi.config=e.webApis.config),e.webApis.update&&(i.mapWebApi.update=e.webApis.update),e.webApis.download&&(i.mapWebApi.download=e.webApis.download)),e.exportDomainOld&&(zs.exporter.dataMgr.URL=e.exportDomainOld),e.exportDomainNew&&(zs.exporter.dataMgr.NEWURL=e.exportDomainNew)),zs.log.debug("remote webSetting","Network",e)}await i.ping().catch(t=>t),"v2"==i.version&&await i.authorization().catch(t=>t);let e={user_id:1,user_type:1,update_time:Date.now(),is_new:0,is_shielded:0};if(i.domainIdx>=0)if(zs.platform.proxy){let t=await zs.platform.async.getLoginParams().catch(t=>t);t&&(zs.td.justTrack("后台登录","后台登录"),await i.login(t).then(t=>{t.user_id?(e=t,i.ready=!0,zs.log.debug("登陆成功：","Network",t)):zs.td.justTrack("后台登录失败","后台登录失败")}).catch(t=>{zs.td.justTrack("后台登录失败","后台登录失败")}))}else await i.login({uid:"1"}).then(t=>{t.user_id&&(e=t,i.ready=!0,zs.log.debug("登陆成功：","Network",t))}).catch(t=>t),i.ready=!0;i.loginCode="";for(let t=0;t<3;t++)i.loginCode+=zs.utils.randByte();return e}static getUrl(t){return i.domainIdx<0||i.domainIdx>=i.listDomain.length?null:null==i.mapWebApi[t]?(zs.log.error("非法网络接口： "+t,"Network"),null):i.listDomain[i.domainIdx]+"/"+i.version+"/"+i.mapWebApi[t]}static obj2arg(t){var e=[];for(var a in t)e.push(a+"="+t[a]);return e.join("&")}static async post(t,e,a,s,r){if(null==r&&(r=3),zs.platform.proxy&&zs.platform.async.request){let d={"content-type":"application/json"};if("v2"==i.version&&""!=i.authorizationToken&&(d={"content-type":"application/json",authorization:i.authorizationToken},!s)){var o=JSON.stringify(e),n=i.encrypt(o);e._data=n}return new Promise((i,o)=>{zs.log.debug("通讯请求："+t,"Network",e),zs.td.justTrack("通讯请求","通讯请求"),zs.platform.async.request({url:t,data:JSON.stringify(e),timeout:a,header:d,method:"POST"}).then(e=>(zs.log.debug("请求成功："+t,"Network",e),i(e.data.data))).catch(n=>r>0?(zs.log.error("请求重试："+t,"Network",n),this.post(t,e,a,s,--r).then(i).catch(o)):(zs.td.justTrack("通讯请求失败","通讯请求失败"),zs.log.error("请求失败："+t,"Network",n),o(n)))})}return new Promise((o,n)=>{var d=new XMLHttpRequest;let l=!1,g=!1;if(d.timeout=a||1e4,zs.utils.sleep(d.timeout).then(()=>{if(!g)return l=!0,r>0?(zs.log.error("重复请求："+t),this.post(t,e,a,s,--r).then(o).catch(n)):(zs.log.error("请求超时："+t),n())}).catch(t=>t),d.onreadystatechange=(()=>{if(4==d.readyState&&!l){g=!0;var c=d.responseText;if(d.status>=200&&d.status<400){var u={};try{u=JSON.parse(c),"v2"==i.version&&u.code}catch(t){return zs.log.error("请求解析失败： ",t),n(t)}return zs.log.debug("请求成功："+t,"Network",c),o(u.data)}return r>0?(zs.log.error("重复请求："+t,c),this.post(t,e,a,s,--r).then(o).catch(n)):(zs.log.error("请求失败："+t,c),n(c))}}),d.ontimeout=(i=>{if(!g&&!l)return g=!0,l=!0,r>0?(zs.log.error("重复请求："+t,i),this.post(t,e,a,s,--r).then(o).catch(n)):(zs.log.error("请求超时： "+t,i),n(i))}),d.open("POST",t,!0),d.setRequestHeader("Content-Type","application/json"),"v2"==i.version&&""!=i.authorizationToken&&(d.setRequestHeader("authorization",i.authorizationToken),!s)){var c=JSON.stringify(e),u=i.encrypt(c);e._data=u}d.send(JSON.stringify(e)),zs.log.debug("通讯请求："+t,"Network",e)})}static get(t,e,a,i){return null==i&&(i=3),zs.platform.proxy&&zs.platform.async.request?new Promise((s,r)=>{zs.log.debug("通讯请求："+t,"Network",e),zs.td.justTrack("通讯请求","通讯请求"),zs.platform.async.request({url:t,data:JSON.stringify(e),timeout:a,method:"GET"}).then(e=>(zs.log.debug("请求成功："+t,"Network",e),s(e.data.data))).catch(o=>i>0?(zs.log.error("请求重试："+t,"Network",o),this.get(t,e,a,--i).then(s).catch(r)):(zs.td.justTrack("通讯请求失败","通讯请求失败"),zs.log.error("请求失败："+t,"Network",o),r(o)))}):new Promise((s,r)=>{var o=new XMLHttpRequest;let n=!1,d=!1;o.timeout=a||1e4,zs.utils.sleep(o.timeout).then(()=>{if(!d)return n=!0,i>0?(zs.log.error("重复请求："+t),this.get(t,e,a,--i).then(s).catch(r)):(zs.log.error("请求超时："+t),r())}).catch(t=>t),o.onreadystatechange=(()=>{if(4==o.readyState&&!n){d=!0;var l=o.responseText;if(o.status>=200&&o.status<400){var g={};try{g=JSON.parse(l)}catch(t){return zs.log.error("请求解析失败： ",t),r(t)}return zs.log.debug("请求成功："+t,"Network",l),s(g.data)}return i>0?(zs.log.error("重复请求："+t,l),this.get(t,e,a,--i).then(s).catch(r)):(zs.log.error("请求失败："+t,l),r(l))}}),o.ontimeout=(o=>{if(!d&&!n)return d=!0,n=!0,i>0?(zs.log.error("重复请求："+t,o),this.get(t,e,a,--i).then(s).catch(r)):(zs.log.error("请求超时： "+t,o),r(o))}),o.open("GET",t,!0),o.setRequestHeader("Content-Type","application/json");let l=JSON.stringify(e);o.send(l),zs.log.debug("通讯请求："+t,"Network",l)})}static nativeRequest(t,e,s,r,o,n){let d=Math.round((new Date).getTime()/1e3).toString();if(e=Object.assign(e,{timestamp:d}),r){let t=a.buildSign(e,!o);e=Object.assign(e,{sign:t})}return new Promise((a,s)=>{if("v2"==i.version&&""!=i.authorizationToken&&!n){var r=JSON.stringify(e),o=i.encrypt(r);e._data=o}this.post(t,e,3e3,!0).then(t=>{a(t)}).catch(t=>{s(t)})})}static request(t,a,s){return new Promise((r,o)=>{let n=null,d=i.getUrl(t),l=null;if(zs.configs.gameCfg.local&&(s=e.Local),d&&(null==s||s==e.Sync))return i.post(d,a).then(e=>{let s=null;switch(t){case"config":a&&"module"===a.type?a.module?(s=a.module?a.module:"base_module",a.table&&(s+=">>"+a.table)):a.table&&(s=a.table):a&&"switch"===a.type&&(s="switch");break;case"download":s=a.key;break;case"auth":i.authorizationToken=e.token,i.authorizationSecret=e.secret}null==e||""==e||"Array"==typeof e&&0==e.length?e=i.getLocalData(t,s):i.setLocalData(t,e,s),r(e)}).catch(t=>{o(t)});if(null==d||s===e.Local||s===e.Async){switch(t){case"login":n=i.getLocalData(t);break;case"config":let e=null;a&&"module"===a.type?a.module?(e=a.module?a.module:"base_module",a.table&&(e+=">>"+a.table)):a.table&&(e=a.table):a&&a.type,e="switch",n=i.getLocalData(t,e);break;case"download":a&&a.key&&(n=i.getLocalData(t,a.key));break;case"update":a&&a.key&&a.data&&i.setLocalData("download",a.data,a.key),n=!0}if(null==n&&zs.log.fatal("本地网络缓存及默认值不存在: "+t,"Network"),l=n,null==d||s===e.Local)return zs.log.debug(t+" 通讯返回本地数据","Network"),r(l)}return i.post(d,a).then(e=>{let s=null;switch(t){case"config":a&&"module"===a.type&&(s=a.module?a.module:"base_module",a.table&&(s+="_"+a.table));break;case"download":s=a.key}null!=e&&""!=e&&i.setLocalData(t,e,s)}).catch(t=>t),r(l)})}static getLocalData(t,e){let a=t;e&&(a+=">>"+e);let s=zs.utils.getItem("network_"+a);return s?JSON.parse(s):i.defaultData[a]}static setLocalData(t,e,a){if(null==e||null==e)return;let i=t;a&&(i+=">>"+a);let s=JSON.stringify(e);s&&zs.utils.setItem("network_"+i,s)}static async ping(){i.domainIdx=-1;for(let t=0;t<i.listDomain.length;t++){let e=i.listDomain[t]+"/"+i.version+"/"+i.mapWebApi.ping,a={};if(await i.get(e,a,1e3).then(e=>{i.domainIdx=t,zs.product.city=e.city,zs.product.country=e.country,zs.product.timestamp=1e3*e.timestamp}).catch(t=>{zs.log.warn("域名 "+e+" 无法正常通讯","Network")}),i.domainIdx>=0)break;await zs.utils.sleep(1e3)}}static async authorization(){let t={};return t.gid=window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,i.request("auth",t)}static async login(t,e){return null==t&&(t={}),t.gid=window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,zs.log.debug("登录参数：","Network",t),i.request("login",t,e)}static async config(t,e,a,s){i.ready||await i.init();let r={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,type:t?"switch":"module",v:zs.configs.gameCfg.version};return t||(r.module=e||"base_module",a&&(r.table=a)),i.request("config",r,s)}static async jsonConfig(t,e){i.ready||await i.init();let a={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,type:"json",v:zs.configs.gameCfg.version,module:"base_module"};return t&&(a.table=t),i.request("config",a,e)}static async update(t,e,a){i.ready||await i.init();let s={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,uid:zs.core.userId,key:t,data:e};return i.request("update",s,a)}static async download(t,e){i.ready||await i.init();let a={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,uid:zs.core.userId,key:t};return i.request("download",a,e)}static log(t,e){window.zs.platform.config.platformMark,zs.configs.gameCfg.appId,zs.core.userId}static edit(t,e,a){let s={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,uid:zs.core.userId,key:t,val:e};return i.request("edit",s,a)}static behavior(t,e,a,s){let r={event_id:t,type:e,record:a};return i.request("behavior",r,s)}static report(t,e,a,s,r){let o={gid:window.zs.platform.config.platformMark+zs.configs.gameCfg.gameId,app_id:window.zs.platform.config.platformMark+zs.configs.gameCfg.appId,platform_id:i.platformId[zs.platform.config.platformMark],uid:zs.core.userId,open_id:zs.exporter.dataMgr.getUUID(),group:t,event:e,name:a,version:zs.configs.gameCfg.version,params:s,timestamp:Math.round((new Date).getTime()/1e3).toString()};return i.request("report",o,r)}}i.ready=!1,i.version="v2",i.domainIdx=-1,i.city=null,i.timestamp=null,i.defaultData={},i.remoteWebSettingURL="https://changshazhise01-1254961065.cos.ap-guangzhou.myqcloud.com/zhise/new_framework/web.json",i.authorizationToken="",i.authorizationSecret="",i.listDomain=["https://gamesapi.zxmn2018.com","https://gamesapi.qwpo2018.com","https://gamesapi.zaml2018.com"],i.mapWebApi={auth:"game/auth",ping:"game/clientInfo",login:"game/login",config:"game/config",update:"game/update",download:"game/download",report:"game/report",log:"game/log",behavior:"ad/behavior",edit:"game/edit"},i.platformId={wx_:1,oppo_:2,vivo_:3,qq_:4,tt_:5,app_:6,ks_:7,hw_:8},t.NetworkMode=e,t.MD5=a,t.network=i}(window.zs=window.zs||{});